Lab Work 5: Digital Payment API Demo Integration

Objective:
Understand the process of integrating a local e-commerce site with a Nepali digital payment API (e.g., eSewa, Khalti).

1. Select a Payment Provider:
For this integration, eSewa is chosen as the digital payment provider.

2. Create the Report:

2.1 Introduction:

Lab Work Progression Overview (Lab 1 to Lab 4):

Lab Work 1: User Management System (Registration and Login)
The foundation of our e-commerce platform was established through a comprehensive user management system. This lab focused on creating secure user authentication and authorization mechanisms using modern web technologies.

Key Implementations:
- User Registration System: Implemented secure user registration with email validation, password encryption using bcrypt hashing, and input sanitization to prevent security vulnerabilities.
- Login Authentication: Developed JWT (JSON Web Token) based authentication system for secure session management, allowing users to maintain logged-in state across browser sessions.
- Password Security: Integrated password strength validation, secure password hashing with salt rounds, and password reset functionality via email verification.
- User Roles & Permissions: Established role-based access control (RBAC) system with distinct user types - customers and administrators - each with specific permissions and access levels.
- Profile Management: Created user profile pages allowing customers to update personal information, manage account settings, and view account activity.
- Security Features: Implemented protection against common vulnerabilities including SQL injection, XSS attacks, and CSRF protection through proper input validation and sanitization.

Technical Stack: Node.js with Express.js backend, MongoDB for user data storage, bcrypt for password hashing, JWT for authentication tokens, and React.js for frontend user interfaces.

Lab Work 2: Product Catalog with Listing and Search
Building upon the user management foundation, this lab developed a comprehensive product catalog system with advanced listing and search capabilities to enhance user shopping experience.

Key Implementations:
- Product Database Design: Created detailed product schema with fields for title, description, price, sale price, category, brand, stock quantity, and multiple image support.
- Category Management: Implemented hierarchical product categorization system with eco-friendly focus including categories like Organic Food, Sustainable Fashion, Green Electronics, and Eco Home products.
- Advanced Search Functionality: Developed multi-parameter search system allowing users to search by product name, category, price range, brand, and availability status with real-time filtering capabilities.
- Product Listing Views: Created multiple product display options including grid view, list view, and detailed product pages with image galleries, specifications, and pricing information.
- Filtering & Sorting: Implemented advanced filtering options by price range, brand, category, customer ratings, and eco-friendly certifications with dynamic sorting by price, popularity, and newest arrivals.
- Image Management: Integrated Cloudinary service for efficient image upload, storage, optimization, and delivery with multiple image formats support.
- Pagination System: Developed efficient pagination to handle large product catalogs with optimized database queries and smooth user navigation.

Technical Stack: MongoDB with indexed collections for fast search, Cloudinary for image management, React.js with advanced state management, and RESTful API endpoints for data retrieval.

Lab Work 3: Interactive Shopping Cart System
This lab focused on creating a dynamic and user-friendly shopping cart system that provides seamless product selection, quantity management, and checkout preparation functionality.

Key Implementations:
- Dynamic Cart Operations: Developed real-time add-to-cart functionality with instant quantity updates, item removal, and cart persistence across user sessions using local storage and database synchronization.
- Cart State Management: Implemented Redux state management for consistent cart data across all application components, ensuring cart contents remain synchronized between different pages and user actions.
- Quantity Management: Created intelligent quantity controls with stock validation, maximum quantity limits, and real-time price calculations including subtotals, taxes, and delivery charges.
- Cart Persistence: Established cart data persistence for logged-in users stored in database and guest users using browser local storage, with automatic cart merging upon user login.
- Price Calculations: Implemented comprehensive pricing system including product prices, quantity discounts, delivery charges based on location, tax calculations, and final total computation.
- Cart Validation: Added cart validation mechanisms to check product availability, stock levels, price changes, and product status before checkout to prevent ordering unavailable items.
- User Experience Enhancements: Created cart sidebar for quick access, cart icon with item count badge, empty cart states, and smooth animations for cart operations.
- Delivery Options: Integrated delivery charge calculation based on customer location with free delivery thresholds and multiple delivery options.

Technical Stack: Redux for state management, React Context API for cart operations, MongoDB for cart persistence, and real-time updates using optimistic UI patterns.

Lab Work 4: Product Feedback and Review System
The final foundational lab implemented a comprehensive product review and rating system to build customer trust and provide valuable feedback for product quality assessment.

Key Implementations:
- Review Submission System: Developed user-friendly review interface allowing customers to submit detailed product reviews with star ratings (1-5 scale), written feedback, and review timestamps.
- Rating Aggregation: Implemented sophisticated rating calculation system that computes average ratings, rating distributions, and displays review statistics with visual star representations.
- Review Display & Management: Created review listing interface with pagination, sorting options (newest, oldest, highest rated, lowest rated), and review filtering capabilities.
- Review Validation: Added review authenticity measures including verified purchase requirements, duplicate review prevention, and inappropriate content filtering.
- User Review History: Developed user review management pages allowing customers to view, edit, and delete their submitted reviews with review status tracking.
- Review Moderation: Implemented admin review moderation system with capabilities to approve, reject, or flag reviews for quality control and content management.
- Review Helpfulness: Added review helpfulness voting system where users can mark reviews as helpful or unhelpful to improve review quality ranking.
- Review Analytics: Created review analytics dashboard for administrators to monitor review trends, customer satisfaction metrics, and product performance insights.

Technical Stack: MongoDB for review storage with indexed queries, React.js for interactive review components, Node.js for review processing APIs, and real-time updates for review submissions.

Current Lab 5: eSewa Payment Gateway Integration
Building upon the solid foundation established in the previous four labs, Lab 5 focuses on integrating Nepal's leading digital payment gateway, eSewa, to enable secure online transactions and complete the e-commerce ecosystem.

eSewa Payment Gateway Overview:
eSewa is Nepal's pioneering digital wallet and payment gateway, launched in 2009 by F1Soft International. It has revolutionized digital payments in Nepal and has become the most trusted and widely used payment platform in the country, serving over 5 million users for online transactions, bill payments, and e-commerce purchases.

Key Features of eSewa:
- Digital Wallet Services: Secure online payment processing with multiple funding sources including bank accounts, debit cards, and direct wallet top-ups
- Comprehensive Payment Solutions: Mobile top-up services, utility bill payments, government service payments (taxes, vehicle renewals), and peer-to-peer money transfers
- E-commerce Integration: Robust payment gateway specifically designed for online merchants with comprehensive API support and developer tools
- QR Code Payments: Modern QR code-based payment system for physical store transactions bridging online and offline payment experiences
- Banking Integration: Direct integration with major Nepali banks including Nepal Investment Bank, Kumari Bank, Laxmi Bank, and others for seamless fund transfers
- Government Services: Official payment partner for various government services including tax payments, utility bills, and administrative fees

Why eSewa for E-commerce Integration:
1. Market Dominance: Largest digital payment platform in Nepal with over 70% market share in digital wallet services
2. Customer Trust: Well-established brand with highest user confidence and trust ratings in Nepal's fintech sector
3. Technical Excellence: Robust API architecture with comprehensive documentation, sandbox environment, and developer support
4. Security Standards: Advanced encryption protocols, PCI DSS compliance, and multi-layer fraud protection systems
5. Local Expertise: Nepal-based company with deep understanding of local market needs, customer behavior, and regulatory requirements
6. Wide Merchant Network: Accepted by majority of online merchants, service providers, and government institutions across Nepal
7. Mobile Optimization: Fully optimized mobile payment experience with dedicated mobile app and responsive web interface

Technical Advantages for Integration:
- RESTful API Architecture: Modern API design following REST principles for easy integration and maintenance
- HMAC-SHA256 Security: Industry-standard signature verification for transaction security and data integrity
- Comprehensive Testing: Dedicated sandbox environment with test credentials for thorough testing before production deployment
- Multiple Payment Methods: Support for wallet payments, bank transfers, and card payments through single integration
- Real-time Notifications: Instant payment status notifications and webhooks for immediate transaction updates
- Transaction Reporting: Detailed transaction logs, analytics dashboard, and comprehensive reporting tools for business insights
- Developer Support: Dedicated technical support team, detailed documentation, and integration guides for developers

Integration Significance:
The integration of eSewa payment gateway represents the culmination of our e-commerce development journey, transforming our platform from a basic product catalog to a fully functional online store capable of processing real monetary transactions. This integration enables customers to complete purchases securely, provides merchants with reliable payment processing, and establishes trust through Nepal's most recognized payment brand.

The eSewa integration builds directly upon all previous lab foundations:
- User Management (Lab 1): Secure user authentication ensures only verified users can make payments
- Product Catalog (Lab 2): Rich product information enables accurate payment processing with correct amounts and product details
- Shopping Cart (Lab 3): Cart functionality provides the order details and total amounts required for payment processing
- Review System (Lab 4): Customer reviews build trust and confidence needed for online payment decisions

This comprehensive integration creates a complete e-commerce ecosystem that combines user management, product discovery, cart functionality, customer feedback, and secure payment processing into a seamless online shopping experience tailored for the Nepali market.

2.2 System Flow Diagram:

REQUEST-RESPONSE INTERACTION FLOW

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Customer      │    │   E-commerce    │    │   eSewa         │    │   Database      │
│   Browser       │    │   Application   │    │   Gateway       │    │   Server        │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │                       │
         │                       │                       │                       │
    1. Add to Cart               │                       │                       │
         ├──────────────────────►│                       │                       │
         │                       │                       │                       │
    2. Proceed to Checkout       │                       │                       │
         ├──────────────────────►│                       │                       │
         │                       │                       │                       │
    3. Select eSewa Payment      │                       │                       │
         ├──────────────────────►│                       │                       │
         │                       │                       │                       │
         │                  4. Create Order              │                       │
         │                       ├──────────────────────────────────────────────►│
         │                       │                       │                       │
         │                  5. Generate Payment Data     │                       │
         │                       │                       │                       │
         │                  6. HMAC Signature           │                       │
         │                       │                       │                       │
         │                  7. Payment Form Data        │                       │
         │                       ├──────────────────────►│                       │
         │                       │                       │                       │
    8. Redirect to eSewa         │                       │                       │
         ├─────────────────────────────────────────────►│                       │
         │                       │                       │                       │
    9. Enter Payment Details     │                       │                       │
         ├──────────────────────────────────────────────┤                       │
         │                       │                       │                       │
   10. Process Payment           │                       │                       │
         ├──────────────────────────────────────────────┤                       │
         │                       │                       │                       │
   11. Payment Callback          │                       │                       │
         ├─────────────────────►│◄──────────────────────┤                       │
         │                       │                       │                       │
         │                 12. Verify Payment           │                       │
         │                       ├──────────────────────►│                       │
         │                       │                       │                       │
         │                 13. Verification Response    │                       │
         │                       │◄──────────────────────┤                       │
         │                       │                       │                       │
         │                 14. Update Order Status      │                       │
         │                       ├──────────────────────────────────────────────►│
         │                       │                       │                       │
         │                 15. Clear Cart               │                       │
         │                       ├──────────────────────────────────────────────►│
         │                       │                       │                       │
         │                 16. Send Confirmation Email  │                       │
         │                       │                       │                       │
   17. Redirect to Success Page │                       │                       │
         │◄──────────────────────┤                       │                       │
         │                       │                       │                       │

DETAILED STEP-BY-STEP FLOW:

Phase 1: Order Initiation
1. Customer adds products to shopping cart
2. Customer proceeds to checkout page
3. Customer selects delivery address
4. Customer chooses eSewa as payment method
5. Customer clicks "Proceed to Payment"

Phase 2: Order Processing
6. Frontend sends order creation request to backend
   Request: POST /api/shop/order/create
   Payload: {
     userId, cartItems, addressInfo, paymentMethod: "esewa",
     totalAmount, orderDate
   }

7. Backend creates order with "pending" status in database
8. Backend generates eSewa payment form data
9. Backend creates HMAC-SHA256 signature for security
10. Backend responds with payment data and eSewa URL

Phase 3: eSewa Payment Processing
11. Frontend dynamically creates form with payment data
12. User is redirected to eSewa payment gateway
13. Customer enters eSewa credentials (PIN/Password)
14. eSewa processes the payment transaction
15. eSewa validates customer account and balance

Phase 4: Payment Completion & Verification
16. eSewa redirects back to application with payment parameters
    Callback URL: /shop/esewa-return?oid=ORDER_ID&amt=AMOUNT&refId=REFERENCE_ID

17. Application extracts payment parameters (oid, amt, refId)
18. Application sends verification request to backend
    Request: POST /api/shop/order/capture
    Payload: { oid, amt, refId, orderId }

19. Backend verifies payment data using eSewa verification API
20. Backend validates payment amount and order details

Phase 5: Order Finalization
21. Backend updates order status to "confirmed"
22. Backend updates payment status to "paid"
23. Backend reduces product inventory
24. Backend clears customer's shopping cart
25. Backend sends order confirmation email
26. Customer is redirected to success page

ERROR HANDLING FLOWS:

Payment Failure Flow:
- If payment fails at eSewa, customer is redirected to failure URL
- Application displays error message and provides retry option
- Order remains in "pending" status for potential retry

Verification Failure Flow:
- If payment verification fails, order status remains "pending"
- Customer service is notified for manual verification
- Detailed error logs are maintained for debugging

Network Error Flow:
- If network issues occur during payment, timeout handling is implemented
- Customer is provided with order reference for manual verification
- Background job retries verification process

Security Measures in Flow:
1. HMAC-SHA256 signature verification prevents payment tampering
2. Server-side validation ensures data integrity
3. Secure HTTPS communication throughout the process
4. Payment amount cross-verification between frontend and backend
5. Transaction UUID prevents duplicate payment processing

Data Flow Security:
- All sensitive data is encrypted during transmission
- Payment credentials never stored in application database
- eSewa tokens are validated on every transaction
- Audit logs maintained for all payment operations

Integration Benefits:
1. Seamless user experience with minimal redirections
2. Real-time payment status updates
3. Automatic inventory management
4. Comprehensive error handling and recovery
5. Secure transaction processing with industry standards
